<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Journally - Daily Mastery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        .habit-card { animation: slideIn 0.3s ease-out forwards; }
        .no-select { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans selection:bg-indigo-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        const SUPABASE_URL = 'https://thxyvciairbocmogbsaa.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRoeHl2Y2lhaXJib2Ntb2dic2FhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NzI0MzYsImV4cCI6MjA4NjI0ODQzNn0.0nUXzaBsDb6fHpGshOFWwNMuq6FuaQt6dwAmJJQqRS4'; 
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        function App() {
            const [session, setSession] = useState(null);
            const [loading, setLoading] = useState(true);
            const [viewDate, setViewDate] = useState(new Date());
            const [goals, setGoals] = useState([]);
            const [logs, setLogs] = useState([]);
            const [swipedId, setSwipedId] = useState(null);
            const [isSyncing, setIsSyncing] = useState(false);

            const dateKey = viewDate.toISOString().split('T')[0];

            // --- DATA FETCHING ---
            const refreshData = useCallback(async (user) => {
                const activeUser = user || session?.user;
                if (!activeUser) return;
                
                setIsSyncing(true);
                // 1. Get active goals (Private)
                const { data: activeGoals } = await supabaseClient
                    .from('goals')
                    .select('*')
                    .eq('user_id', activeUser.id)
                    .is('deleted_at', null);
                
                // 2. Get logs for current date
                const { data: dailyLogs } = await supabaseClient
                    .from('logs')
                    .select('*')
                    .eq('user_id', activeUser.id)
                    .eq('logged_date', dateKey);

                setGoals(activeGoals || []);
                setLogs(dailyLogs || []);
                setIsSyncing(false);
            }, [session, dateKey]);

            useEffect(() => {
                supabaseClient.auth.getSession().then(({ data: { session: s } }) => {
                    setSession(s);
                    if (s) refreshData(s).then(() => setLoading(false));
                    else setLoading(false);
                });
            }, [dateKey]);

            // --- ACTIONS ---
            const toggleHabit = async (goalId) => {
                const existing = logs.find(l => l.goal_id === goalId);
                if (existing) {
                    await supabaseClient.from('logs').delete().eq('id', existing.id);
                } else {
                    await supabaseClient.from('logs').insert([{ 
                        goal_id: goalId, 
                        user_id: session.user.id, 
                        logged_date: dateKey 
                    }]);
                }
                refreshData();
            };

            const addHabit = async () => {
                const name = prompt("What's the new habit?");
                if (!name) return;
                await supabaseClient.from('goals').insert([{ name, user_id: session.user.id }]);
                refreshData();
            };

            const archiveHabit = async (id) => {
                await supabaseClient.from('goals').update({ deleted_at: new Date().toISOString() }).eq('id', id);
                setSwipedId(null);
                refreshData();
            };

            if (loading) return (
                <div className="h-screen flex items-center justify-center bg-white">
                    <div className="flex flex-col items-center gap-4">
                        <div className="w-8 h-8 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Authenticating</p>
                    </div>
                </div>
            );

            return (
                <div className="max-w-md mx-auto min-h-screen p-6 pb-32 no-select" onClick={() => setSwipedId(null)}>
                    {/* Header */}
                    <header className="flex justify-between items-center mb-10">
                        <div>
                            <h1 className="text-3xl font-black italic text-indigo-600 leading-none">Journally</h1>
                            <p className="text-[10px] font-bold text-slate-400 uppercase mt-1 tracking-wider">Your Daily Evolution</p>
                        </div>
                        <div className={`w-3 h-3 rounded-full transition-colors duration-500 ${isSyncing ? 'bg-amber-400 animate-pulse' : 'bg-green-500'}`}></div>
                    </header>

                    {/* Date Navigator */}
                    <div className="bg-white rounded-[2.5rem] p-2 shadow-sm border border-slate-100 flex items-center justify-between mb-8">
                        <button onClick={() => { const d = new Date(viewDate); d.setDate(d.getDate()-1); setViewDate(d); }} className="w-12 h-12 flex items-center justify-center text-indigo-600 font-bold hover:bg-slate-50 rounded-full transition-colors">←</button>
                        <div className="text-center">
                            <span className="block text-xs font-black text-indigo-600 uppercase tracking-tighter">
                                {viewDate.toLocaleDateString(undefined, { month: 'short' })}
                            </span>
                            <span className="text-xl font-black text-slate-800">
                                {viewDate.toLocaleDateString(undefined, { day: 'numeric' })}
                            </span>
                        </div>
                        <button onClick={() => { const d = new Date(viewDate); d.setDate(d.getDate()+1); setViewDate(d); }} className="w-12 h-12 flex items-center justify-center text-indigo-600 font-bold hover:bg-slate-50 rounded-full transition-colors">→</button>
                    </div>

                    {/* Habit Feed */}
                    <div className="space-y-4">
                        {goals.length === 0 && (
                            <div className="text-center py-20 bg-slate-100/50 rounded-[3rem] border-2 border-dashed border-slate-200">
                                <p className="text-slate-400 font-bold text-sm">No habits active today.</p>
                            </div>
                        )}

                        {goals.map(g => {
                            const isDone = logs.some(l => l.goal_id === g.id);
                            return (
                                <div key={g.id} className="relative overflow-hidden rounded-[2rem] habit-card">
                                    {/* Archive Action (Hidden Layer) */}
                                    <div className="absolute inset-0 bg-red-500 flex justify-end items-center pr-6">
                                        <button onClick={() => archiveHabit(g.id)} className="text-white font-black text-xs uppercase tracking-widest">Archive</button>
                                    </div>

                                    {/* Main Card Layer */}
                                    <div 
                                        style={{ transform: swipedId === g.id ? 'translateX(-100px)' : 'translateX(0)' }}
                                        className="relative z-10 bg-white p-6 border-2 border-slate-50 rounded-[2rem] flex justify-between items-center transition-transform duration-300 ease-in-out cursor-pointer shadow-sm active:scale-[0.98]"
                                        onClick={(e) => { e.stopPropagation(); swipedId === g.id ? setSwipedId(null) : toggleHabit(g.id); }}
                                        onTouchStart={(e) => { this.tX = e.touches[0].clientX; }}
                                        onTouchMove={(e) => {
                                            const diff = this.tX - e.touches[0].clientX;
                                            if (diff > 50) setSwipedId(g.id);
                                            if (diff < -50) setSwipedId(null);
                                        }}
                                    >
                                        <div className="flex flex-col">
                                            <span className={`text-lg font-bold transition-all ${isDone ? 'text-slate-300 line-through' : 'text-slate-800'}`}>
                                                {g.name}
                                            </span>
                                            <span className="text-[9px] font-black text-slate-300 uppercase tracking-widest">Personal Goal</span>
                                        </div>
                                        <div className={`w-10 h-10 rounded-2xl flex items-center justify-center transition-all duration-300 ${isDone ? 'bg-indigo-600 shadow-lg shadow-indigo-200' : 'bg-slate-50 border-2 border-slate-100'}`}>
                                            {isDone && <span className="text-white text-lg">✓</span>}
                                        </div>
                                    </div>
                                </div>
                            );
                        })}

                        <button 
                            onClick={addHabit}
                            className="w-full py-8 rounded-[2.5rem] border-2 border-dashed border-slate-200 text-slate-400 font-black text-xs uppercase tracking-[0.2em] hover:bg-white hover:border-indigo-200 hover:text-indigo-400 transition-all active:scale-95"
                        >
                            + New Habit
                        </button>
                    </div>

                    {/* Quick Stats Preview */}
                    <div className="mt-12 p-8 bg-indigo-600 rounded-[3rem] text-white shadow-xl shadow-indigo-100">
                        <p className="text-[10px] font-black uppercase tracking-widest opacity-60 mb-1">Today's Progress</p>
                        <h3 className="text-3xl font-black italic">
                            {goals.length > 0 ? Math.round((logs.length / goals.length) * 100) : 0}%
                        </h3>
                        <div className="mt-4 w-full h-2 bg-indigo-400/30 rounded-full overflow-hidden">
                            <div 
                                className="h-full bg-white rounded-full transition-all duration-700"
                                style={{ width: `${goals.length > 0 ? (logs.length / goals.length) * 100 : 0}%` }}
                            ></div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
